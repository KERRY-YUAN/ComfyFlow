<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/icon.ico" type="image/x-icon">
    <title>设计工具界面</title>
    <style>
        /* --- Base Styles / 基本样式 --- */
        html { height: 100%; font-size: clamp(10px, 1.2vmin, 15px); box-sizing: border-box; }
        *, *:before, *:after { box-sizing: inherit; }
        body {
            font-family: system-ui, sans-serif;
            margin: 0;
            padding: 0 0 2.5rem 0; /* Space for log footer / 为日志页脚留出空间 */
            background-color: #1e1e1e;
            color: #d4d4d4;
            display: flex;
            min-height: 100vh;
            font-size: 0.9rem;
            line-height: 1.5;
            overflow: hidden; /* Prevent body scroll / 防止主体滚动 */
        }
        /* --- Main Layout / 主要布局 --- */
        .container { display: flex; width: 100%; height: calc(100vh - 2.5rem); /* Adjusted for footer / 为页脚调整 */ padding: 1rem; gap: 1rem; }
        /* --- Left Sidebar / 左侧边栏 --- */
        .sidebar { width: 20rem; flex-shrink: 0; background-color: #2a2a2a; padding: 1rem; display: flex; flex-direction: column; border-radius: 0.3rem; height: 100%; gap: 1rem; }
        .sidebar-content-area { flex-grow: 1; flex-shrink: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 1rem; min-height: 0; box-sizing: border-box; scrollbar-width: thin; scrollbar-color: #555 #2a2a2a; }
        .sidebar-content-area::-webkit-scrollbar { width: 8px; }
        .sidebar-content-area::-webkit-scrollbar-track { background: #2a2a2a; }
        .sidebar-content-area::-webkit-scrollbar-thumb { background-color: #555; border-radius: 4px; border: 2px solid #2a2a2a; }
        .flexible-content { flex-grow: 1; display: flex; flex-direction: column; gap: 1rem; min-height: 0; }
        /* General Section Styling / 通用区域样式 */
        .sidebar-section { background-color: #333; padding: 0.8rem 1rem; border-radius: 0.25rem; flex-grow: 0; flex-shrink: 1; display: flex; flex-direction: column; }
        .sidebar-section.upload-section { flex-grow: 3; min-height: 7rem; }
        .sidebar-section.text-prompt { flex-grow: 1; min-height: 4rem; }
        /* Section Titles / 区域标题 */
        .sidebar-section label, .sidebar-section h3 { display: block; font-size: 0.9rem; margin: 0 0 0.6rem 0; font-weight: 600; color: #cccccc; flex-shrink: 0; }
        /* --- Specific Controls / 特定控件 --- */
        .top-bar { display: flex; align-items: center; padding: 0.5rem 1rem; background-color: #333; border-radius: 0.25rem; flex-shrink: 0; }
        .top-bar label { margin-right: 0.6rem; font-weight: 600; color: #cccccc; white-space: nowrap; margin-bottom: 0; }
        .top-bar select { flex-grow: 1; min-width: 3rem; padding: 0.4rem 0.6rem; background-color: #444; border: 1px solid #555; color: #d4d4d4; border-radius: 0.25rem; cursor: pointer; }
        .upload-box { width: 100%; height: auto; flex-grow: 1; min-height: 5rem; background-color: #444; border: 1px dashed #888; display: flex; justify-content: center; align-items: center; position: relative; cursor: pointer; border-radius: 0.25rem; overflow: hidden; transition: background-color 0.2s ease, border-color 0.2s ease; }
        .upload-box:hover { background-color: #505050; border-color: #aaa; }
        .upload-box .plus-sign { font-size: 2.5rem; color: #888; position: absolute; z-index: 1; pointer-events: none; }
        .upload-box img.preview-image { max-width: 100%; max-height: 100%; object-fit: contain; position: absolute; z-index: 0; display: none; }
        .upload-box input[type="file"] { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 2; }
        /* Adding feedback styles directly here for simplicity */
        /* 为简单起见，在此处直接添加反馈样式 */
        .upload-box.success { border-color: lightgreen !important; background-color: #454; }
        .upload-box.error { border-color: red !important; background-color: #544; }
        .text-prompt textarea { width: 100%; height: auto; flex-grow: 1; min-height: 3rem; background-color: #444; border: 1px solid #555; color: #d4d4d4; padding: 0.6rem; border-radius: 0.25rem; resize: vertical; font-size: 0.9rem; line-height: 1.5; }
        .text-prompt textarea::placeholder { color: #888; }
        .slider-control { flex-shrink: 0; display: flex; flex-direction: column; gap: 0.4rem; background-color: #333; padding: 0.8rem 1rem; border-radius: 0.25rem; }
        .slider-control > div { display: flex; align-items: center; gap: 0.8rem; }
        .slider-control label { margin-bottom: 0; white-space: nowrap; }
        .slider-control input[type="range"] { flex-grow: 1; cursor: pointer; accent-color: #007bff; min-width: 3rem; height: 0.5rem; }
        .slider-control span { min-width: 3rem; text-align: right; font-weight: 600; }

        /* --- Buttons / 按钮 --- */
        .render-button, .output-actions button { padding: 0.7rem 1.2rem; font-size: 0.9rem; font-weight: 600; line-height: 1.4; height: auto; border-radius: 0.25rem; border: none; cursor: pointer; transition: background-color 0.2s ease, box-shadow 0.2s ease; white-space: nowrap; flex-shrink: 0; display: inline-flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); }
        .render-button:hover, .output-actions button:hover { box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); }
        .render-button { width: 100%; background-color: #007bff; color: white; margin-top: auto; }
        .render-button:hover { background-color: #0056b3; }
        .render-button:disabled { background-color: #5a5a5a; color: #aaa; cursor: not-allowed; box-shadow: none; }

        /* --- Right Main Content / 右侧主内容区 --- */
        .main-content { flex-grow: 1; min-width: 20rem; background-color: #2a2a2a; padding: 1rem; display: flex; flex-direction: column; border-radius: 0.3rem; position: relative; overflow: hidden; height: 100%; }
        .title-toolbar-wrapper { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; flex-shrink: 0; padding: 0.6rem 1rem; background-color: #333; border-radius: 0.25rem; }
        .main-content h2 { margin: 0; padding: 0; background-color: transparent; border-radius: 0; font-size: 1.1rem; font-weight: 600; color: #cccccc; }
        /* Output Area Styles */
        .output-area { flex-grow: 1; background-color: #383838; border: 1px solid #444; border-radius: 0.25rem; position: relative; overflow: hidden; min-height: 10rem; cursor: default; }
        .output-placeholder { display: flex; justify-content: center; align-items: center; width: 100%; height: 100%; color: #aaa; font-size: 1.1rem; position: absolute; top: 0; left: 0; z-index: 0; text-align: center; padding: 1rem; user-select: none; }
        /* Output Layer */
        .output-result-wrapper { position: absolute; top: 0; left: 0; height: 100%; width: 100%; overflow: hidden; z-index: 2; display: none; }
        #output-result-layer { width: 100%; height: 100%; display: block; }
        #output-result-layer img { display: block; width: 100%; height: 100%; object-fit: contain; user-select: none; -webkit-user-drag: none; pointer-events: none; }

        /* Edit Toolbar */
        .local-edit-toolbar { width: auto; height: auto; background-color: transparent; display: flex; flex-direction: row; align-items: center; gap: 0.7rem; flex-shrink: 0; }
        .edit-icon { width: 2.2rem; height: 2.2rem; flex-shrink: 0; background-color: #5a5a5a; border: 1px solid #777; cursor: pointer; border-radius: 0.2rem; display: flex; justify-content: center; align-items: center; color: #ccc; font-size: 0.9rem; font-weight: 600; transition: background-color 0.2s ease, border-color 0.2s ease; }
        .edit-icon:hover { background-color: #6a6a6a; border-color: #999; }
        /* Output Action Buttons */
        .output-actions { display: flex; align-items: center; justify-content: flex-end; gap: 0.8rem; flex-shrink: 0; padding-top: 1rem; }
        .output-actions button { background-color: #007bff; color: white; }
        .output-actions button:hover { background-color: #0056b3; }
        .version-info-footer { font-size: 0.75rem; color: #5a5a5a; margin-right: auto; align-self: center; padding-left: 0.1rem; user-select: none; }

        /* Status Indicator Styles */
        #comfyui-status-indicator { position: absolute; top: 1rem; right: 1rem; padding: 0.4rem 0.8rem; background-color: rgba(0, 0, 0, 0.6); color: #b71c1c; font-size: 0.8rem; font-weight: 500; border-radius: 0.2rem; z-index: 10; display: none; max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; transition: color 0.3s ease, background-color 0.3s ease, opacity 0.5s ease; opacity: 0; }
        #comfyui-status-indicator.visible { display: block; opacity: 1; }
        #comfyui-status-indicator.busy { color: #ffab00; background-color: rgba(80, 60, 0, 0.7); }
        #comfyui-status-indicator.ready { color: #2e7d32; background-color: rgba(46, 125, 50, 0.7); }
        #comfyui-status-indicator.error { color: #ff5252; background-color: rgba(183, 28, 28, 0.7); }

        /* --- Log Footer Styles --- */
        .log-footer { position: fixed; bottom: 0; left: 0; width: 100%; background-color: #1a1a1a; color: #9a9a9a; padding: 0.4rem 1rem; font-size: 0.8rem; line-height: 1.3; z-index: 100; box-shadow: 0 -1px 5px rgba(0, 0, 0, 0.3); box-sizing: border-box; height: 2.5rem; display: flex; align-items: center; }
        #backend-log-display { display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-family: monospace; width: 100%; }
        #backend-log-display.disconnected { color: #ff6b6b; font-style: italic; }
        #backend-log-display.connecting { color: #f0e68c; font-style: italic; }
        #backend-log-display.connected { color: #90ee90; }
        #backend-log-display.progress { color: #87ceeb; }
        #backend-log-display.idle { color: #9a9a9a; }
        #backend-log-display.error { color: #ff5252; } /* Added error style */

        /* Error message specific div (can be used for input validation errors) */
        /* 错误消息特定 div（可用于输入验证错误） */
        .error-message { color: #ff5252; font-size: 0.8rem; margin-top: 0.3rem; min-height: 1em; /* Reserve space */ }
        /* Progress bar container (hidden, as footer provides progress text) */
        /* 进度条容器（隐藏，因为页脚提供进度文本） */
        #progress-bar-container { display: none !important; }

    </style>
    <!-- Include Socket.IO client library -->
    <!-- 包含 Socket.IO 客户端库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.2/socket.io.js" integrity="sha512-VJ6+sp2E5rFQk05caiXXzQd1wBABpjEj1Ql4oL2GlmA2YXhID5GRcnvsfnimNpUJJUsh0h+6DUu7jzMWAWiIKg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

</head>
<body>
    <!-- ComfyUI Status Indicator -->
    <div id="comfyui-status-indicator"></div>

    <div class="container">
        <!-- Left Sidebar -->
        <div class="sidebar">
             <div class="sidebar-content-area" id="sidebar-content">
                <!-- Workflow Selection -->
                <div class="top-bar">
                    <label for="workflow-select">后台工作:</label>
                    <select id="workflow-select">
                        <option value="">--请选择--</option>
                    </select>
                </div>
                <!-- Workflow Error Display -->
                <div id="workflow-error" class="error-message" style="padding: 0 1rem;"></div>

                <!-- Flexible Content Area -->
                <div class="flexible-content">
                    <!-- Line Art Upload -->
                    <div class="sidebar-section upload-section">
                        <h3>上传线稿</h3>
                        <div class="upload-box" id="line-draft-upload-area">
                            <span class="plus-sign">+</span>
                            <img src="#" alt="Line Art Preview" class="preview-image" id="lineart-preview" style="display: none;">
                            <input type="file" id="lineart-upload" accept="image/*" title="点击上传线稿">
                        </div>
                    </div>
                    <!-- Reference Upload -->
                    <div class="sidebar-section upload-section">
                        <h3>上传参考</h3>
                        <div class="upload-box" id="reference-upload-area">
                            <span class="plus-sign">+</span>
                            <img src="#" alt="Reference Preview" class="preview-image" id="reference-preview" style="display: none;">
                            <input type="file" id="reference-upload" accept="image/*" title="点击上传参考图">
                        </div>
                    </div>
                    <!-- Text Prompt -->
                    <div class="sidebar-section text-prompt">
                        <h3>文字要求</h3>
                        <textarea id="text-prompt" rows="3" placeholder="请输入文字要求"></textarea>
                    </div>
                </div>
                <!-- Sliders -->
                <div class="sidebar-section slider-control">
                    <label for="control-strength">控制强度</label>
                    <div>
                        <input type="range" id="control-strength" min="0.0" max="2.0" step="0.01" value="1.0">
                        <span id="control-strength-value">1.00</span>
                    </div>
                </div>
                <div class="sidebar-section slider-control">
                    <label for="card-count">抽卡数量</label>
                    <div>
                        <input type="range" id="card-count" min="1" max="100" step="1" value="1">
                        <span id="card-count-value">1</span>
                    </div>
                </div>
            </div> <!-- End sidebar-content-area -->

            <!-- Render Button -->
            <button class="render-button" id="render-button" disabled>渲染 (Render)</button>
        </div> <!-- End sidebar -->

        <!-- Right Main Content -->
        <div class="main-content">
            <!-- Title and Toolbar wrapper -->
            <div class="title-toolbar-wrapper">
                <h2>成果输出</h2>
                <!-- Edit Toolbar (Placeholder) -->
                <div class="local-edit-toolbar" id="edit-toolbar">
                    <div class="edit-icon" title="编辑工具1">1</div><div class="edit-icon" title="编辑工具2">2</div><div class="edit-icon" title="编辑工具3">3</div><div class="edit-icon" title="编辑工具4">4</div><div class="edit-icon" title="编辑工具5">5</div><div class="edit-icon" title="编辑工具6">6</div><div class="edit-icon" title="编辑工具7">7</div><div class="edit-icon" title="编辑工具8">8</div><div class="edit-icon" title="编辑工具9">9</div><div class="edit-icon" title="编辑工具10">10</div>
                </div>
            </div>
            <!-- Output Area -->
            <div class="output-area" id="output-area">
                 <span class="output-placeholder">等待生成结果...</span>
                 <div class="output-result-wrapper">
                     <div class="output-layer" id="output-result-layer">
                         <img src="" alt="Result Output">
                     </div>
                 </div>
            </div>
            <!-- Output Actions -->
            <div class="output-actions">
                <span class="version-info-footer">Kerry, Ver. 2.0.0</span> <!-- Updated Version -->
                <button id="save-btn">保存</button>
                <button id="save-large-btn">放大并保存</button>
            </div>
        </div> <!-- End main-content -->
    </div> <!-- End container -->

    <!-- Log Footer Element -->
    <div class="log-footer" id="log-footer">
        <span id="backend-log-display" class="disconnected">等待连接...</span>
    </div>

    <!-- Embedded JavaScript (Significant Changes) -->
    <!-- 嵌入的 JavaScript（重大更改） -->
    <script>
    // --- Global variables ---
    let comfyUIStatusIndicatorTimeout = null;
    let mainSocket = null; // Main connection to Flask backend
    let clientId = null; // User's unique SocketIO session ID
    let currentBackendPromptId = null; // Prompt ID tracked by the backend/frontend interaction
    let isRendering = false; // Flag to prevent concurrent renders

    // --- Configuration ---
    // Assuming Flask runs on the same host/port as the page is served from
    // 假设 Flask 在提供页面的同一主机/端口上运行
    const APP_API_BASE = window.location.origin;
    // ComfyUI view URL (assuming standard port or adjust if needed)
    // ComfyUI 查看 URL（假设使用标准端口，或根据需要调整）
    const COMFYUI_API_PORT = {{ comfyui_api_port | default(8188) }}; // Get from Flask template or default
    const COMFYUI_VIEW_URL_BASE = `http://${window.location.hostname}:${COMFYUI_API_PORT}/view`;


    // --- Helper Functions ---
    /** Reads file as Base64 Data URL */
    function readFileAsBase64(file) {
        return new Promise((resolve, reject) => {
            if (!file) { return resolve(null); } // Handle no file case
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = (error) => { console.error("File Read Error:", error); reject(error); };
            reader.readAsDataURL(file);
        });
    }

    /** Updates the log footer text and style */
    function updateFooter(text, statusClass = 'idle') {
        const display = document.getElementById('backend-log-display');
        if (display) {
            display.textContent = text;
            const classes = ['idle', 'connecting', 'connected', 'progress', 'disconnected', 'error', 'busy']; // Added busy
            display.classList.remove(...classes);
            if (statusClass) display.classList.add(statusClass);
        }
        // Show errors also in the dedicated workflow error div if relevant
        // 如果相关，也在专用的工作流错误 div 中显示错误
        const wfErrorDiv = document.getElementById('workflow-error');
        if (wfErrorDiv) {
            if (statusClass === 'error') {
                 wfErrorDiv.textContent = text;
            } else {
                 wfErrorDiv.textContent = ''; // Clear if not an error
            }
        }

    }

    /** Updates top-right status indicator */
    function updateStatusIndicator(message, type = 'busy') {
        const indicator = document.getElementById('comfyui-status-indicator');
        if (!indicator) return;
        indicator.textContent = message;
        indicator.className = 'visible ' + type;
        if (comfyUIStatusIndicatorTimeout) clearTimeout(comfyUIStatusIndicatorTimeout);
        const hideDelay = (type === 'ready' || type === 'error') ? 5000 : 4000; // Longer display for final states/errors
        comfyUIStatusIndicatorTimeout = setTimeout(() => indicator.classList.remove('visible'), hideDelay);
    }

     /** Hides top-right status indicator */
    function hideStatusIndicator() {
         const indicator = document.getElementById('comfyui-status-indicator');
         if (indicator) {
             if (comfyUIStatusIndicatorTimeout) clearTimeout(comfyUIStatusIndicatorTimeout);
             indicator.className = '';
         }
     }

    /** Displays the final rendered image */
     function displayOutputImage(base64ImageData) {
        const outputArea = document.getElementById('output-area');
        const placeholder = outputArea?.querySelector('.output-placeholder');
        const resultWrapper = outputArea?.querySelector('.output-result-wrapper');
        const resultLayerImg = resultWrapper?.querySelector('#output-result-layer img');

        if (!resultLayerImg || !resultWrapper || !placeholder) {
            console.error("Output display elements not found!");
            updateFooter("前端错误：无法显示输出", 'error');
            return;
        }

        if (base64ImageData) {
            placeholder.style.display = 'none';
            // Preload image
            const tempImg = new Image();
            tempImg.onload = () => {
                 resultLayerImg.src = base64ImageData;
                 resultWrapper.style.display = 'block';
                 console.log("Output image displayed.");
                 updateStatusIndicator('渲染完成', 'ready');
                 updateFooter('渲染完成', 'idle'); // Reset footer to idle/connected
                 isRendering = false; // Allow new render
                 const renderBtn = document.getElementById('render-button');
                 if (renderBtn) renderBtn.disabled = false; // Re-enable button
            };
            tempImg.onerror = () => {
                console.error("Failed to load result image data.");
                placeholder.textContent = "加载结果图像失败";
                placeholder.style.display = 'flex';
                resultWrapper.style.display = 'none';
                updateFooter("加载结果图像失败", 'error');
                isRendering = false; // Allow new render
                const renderBtn = document.getElementById('render-button');
                if (renderBtn) renderBtn.disabled = false; // Re-enable button
            };
            tempImg.src = base64ImageData;
        } else {
             // Handle case where no image data is received
             placeholder.textContent = "未收到图像结果";
             placeholder.style.display = 'flex';
             resultWrapper.style.display = 'none';
             console.warn("No image data received to display.");
             updateFooter("未收到图像结果", 'idle');
             isRendering = false; // Allow new render
             const renderBtn = document.getElementById('render-button');
             if (renderBtn) renderBtn.disabled = false; // Re-enable button
        }
    }

    // --- Main Function to Handle Data Request from Backend ---
    async function handleDataRequest(requestData) {
        const { prompt_id, node_id, mode, request_id } = requestData;
        console.log(`<- Received data request from backend: mode=${mode}, req_id=${request_id}`);
        updateFooter(`节点 ${node_id.substring(0,4)} 请求数据: ${mode}...`, 'busy'); // Inform user

        let dataToSend = null;
        let errorMsg = null;

        try {
            switch(mode) {
                case 'Image':
                    const lineartInput = document.getElementById('lineart-upload');
                    if (lineartInput && lineartInput.files.length > 0) {
                        dataToSend = await readFileAsBase64(lineartInput.files[0]);
                         if (!dataToSend) errorMsg = "无法读取线稿文件。";
                    } else {
                         errorMsg = "未选择线稿图像。"; // User hasn't selected a file
                         // dataToSend = null; // Send null explicitly
                    }
                    break;
                case 'Reference':
                    const refInput = document.getElementById('reference-upload');
                     if (refInput && refInput.files.length > 0) {
                        dataToSend = await readFileAsBase64(refInput.files[0]);
                         if (!dataToSend) errorMsg = "无法读取参考文件。";
                    } else {
                         // It's okay if reference is optional, send null
                         dataToSend = null;
                         console.log("No reference image selected, sending null.");
                    }
                    break;
                case 'Text':
                    const textInput = document.getElementById('text-prompt');
                    dataToSend = textInput ? textInput.value : "";
                    break;
                case 'CN':
                    const cnInput = document.getElementById('control-strength');
                    // Send as number, backend expects float
                    dataToSend = cnInput ? parseFloat(cnInput.value) : 1.0;
                    break;
                case 'Count':
                    const countInput = document.getElementById('card-count');
                     // Send as number, backend expects int
                    dataToSend = countInput ? parseInt(countInput.value, 10) : 1;
                    break;
                default:
                    console.error(`Unknown data request mode: ${mode}`);
                    errorMsg = `未知的数据请求模式: ${mode}`;
            }
        } catch (error) {
             console.error(`Error preparing data for mode ${mode}:`, error);
             errorMsg = `准备数据时出错 (${mode}): ${error.message}`;
        }


        // --- Send Data (or error) Back to Backend ---
        const responsePayload = {
            prompt_id: prompt_id,
            node_id: node_id,
            mode: mode,
            request_id: request_id, // Include the request_id
            data: dataToSend,       // This will be null if file reading failed or not selected
            error: errorMsg         // Include error message if any
        };

        if (errorMsg) {
            console.warn(`-> Sending error back for request ${request_id}: ${errorMsg}`);
            updateFooter(`错误: ${errorMsg}`, 'error'); // Show error to user
        } else {
            console.log(`-> Sending data back for request ${request_id}, mode=${mode}`);
        }

        if(mainSocket && mainSocket.connected) {
            mainSocket.emit('provide_data_from_frontend', responsePayload);
        } else {
             console.error("Cannot send data back, socket not connected.");
             updateFooter("连接错误，无法发送数据", 'disconnected');
        }

        // Update footer after sending data/error
        if (!errorMsg) {
             updateFooter(`数据已发送 (${mode})`, 'progress'); // Or 'idle' or 'connected' depending on state
        }
    }


    // --- WebSocket Setup ---
    function connectWebSocket() {
        if (mainSocket && mainSocket.connected) {
            console.log("WebSocket already connected.");
            return;
        }

        // Disconnect previous socket if exists
        if (mainSocket) { mainSocket.disconnect(); }

        console.log("Attempting to connect WebSocket to Backend...");
        updateFooter("正在连接服务器...", 'connecting');
        mainSocket = io.connect(APP_API_BASE, {
            reconnectionAttempts: 5,
            reconnectionDelay: 3000,
        }); // Connect to Flask-SocketIO server

        mainSocket.on('connect', () => {
            clientId = mainSocket.id;
            console.log('WebSocket Connected to Backend. Client ID:', clientId);
            updateFooter('已连接', 'connected');
            // Enable render button potentially (if workflow selected)
            const workflowSelect = document.getElementById('workflow-select');
            const renderBtn = document.getElementById('render-button');
            if(renderBtn) renderBtn.disabled = !(workflowSelect && workflowSelect.value);
        });

        mainSocket.on('disconnect', (reason) => {
            console.log('WebSocket Disconnected from Backend. Reason:', reason);
            clientId = null;
            updateFooter(`已断开: ${reason}`, 'disconnected');
            // Disable render button
            const renderBtn = document.getElementById('render-button');
            if(renderBtn) renderBtn.disabled = true;
            isRendering = false; // Reset rendering flag
        });

        mainSocket.on('connect_error', (error) => {
            console.error('WebSocket Connection Error:', error);
            updateFooter('连接错误', 'disconnected');
            const renderBtn = document.getElementById('render-button');
            if(renderBtn) renderBtn.disabled = true;
        });

        // --- Listen for messages from backend ---

        // Listen for final render results
        mainSocket.on('render_result', (data) => {
            console.log('<- Received final render result:', data);
            if (data.images && data.images.length > 0) {
                displayOutputImage(data.images[0]); // Display the first image
            } else {
                 console.warn("Render result received, but no images found.");
                 displayOutputImage(null); // Show placeholder with message
            }
             // isRendering and button state handled within displayOutputImage
        });

        // Listen for errors during rendering process
        mainSocket.on('render_error', (data) => {
            console.error('<- Received render error:', data);
            updateFooter(`渲染错误: ${data.message}`, 'error');
            updateStatusIndicator('渲染失败', 'error');
            isRendering = false; // Allow new render attempt
            const renderBtn = document.getElementById('render-button');
            if (renderBtn) renderBtn.disabled = false; // Re-enable button
            // Show placeholder in output area
            const outputArea = document.getElementById('output-area');
            const placeholder = outputArea?.querySelector('.output-placeholder');
            const resultWrapper = outputArea?.querySelector('.output-result-wrapper');
            if(placeholder) { placeholder.textContent = `渲染错误: ${data.message}`; placeholder.style.display = 'flex'; }
            if(resultWrapper) resultWrapper.style.display = 'none';

        });

        // Listen for general status updates
        mainSocket.on('status_update', (data) => {
            console.log('<- Status update:', data.status);
            updateFooter(data.status, 'progress'); // Use progress style for most updates
        });

        // Listen for progress updates (optional, if backend sends them)
        mainSocket.on('progress_update', (data) => {
             const { progress, total, percent } = data;
             // console.log(`<- Progress: ${progress}/${total} (${percent}%)`); // Can be noisy
             updateFooter(`进度: ${progress}/${total} (${percent}%)`, 'progress');
        });

        // *** NEW: Listen for data requests relayed from the backend ***
        mainSocket.on('request_data_for_frontend', handleDataRequest);

    }


    // --- DOM Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM fully loaded");

        // --- Get Element References ---
        const outputArea = document.getElementById('output-area');
        const outputPlaceholder = outputArea?.querySelector('.output-placeholder');
        const resultWrapper = outputArea?.querySelector('.output-result-wrapper');
        const resultLayerImg = resultWrapper?.querySelector('#output-result-layer img');
        const workflowSelect = document.getElementById('workflow-select');
        const renderBtn = document.getElementById('render-button');
        const lineartInput = document.getElementById('lineart-upload');
        const lineartPreview = document.getElementById('lineart-preview');
        const referenceInput = document.getElementById('reference-upload');
        const referencePreview = document.getElementById('reference-preview');
        const textPromptInput = document.getElementById('text-prompt');
        const strengthSlider = document.getElementById('control-strength');
        const strengthValueSpan = document.getElementById('control-strength-value');
        const countSlider = document.getElementById('card-count');
        const countValueSpan = document.getElementById('card-count-value');
        const saveBtn = document.getElementById('save-btn');
        const saveLargeBtn = document.getElementById('save-large-btn');
        const editToolbarElement = document.getElementById('edit-toolbar');

        // --- Initial UI State & Workflow Loading ---
        function updateRenderButtonState() {
            if (renderBtn) {
                const wfSelected = workflowSelect && workflowSelect.value;
                renderBtn.disabled = !wfSelected || isRendering || !mainSocket || !mainSocket.connected;
                if (!wfSelected) {
                     renderBtn.textContent = '选择工作流后可用';
                } else if (isRendering) {
                     renderBtn.textContent = '渲染中...';
                } else if (!mainSocket || !mainSocket.connected) {
                     renderBtn.textContent = '连接中...';
                } else {
                     renderBtn.textContent = '渲染 (Render)';
                }
            }
         }

        if (workflowSelect) {
             workflowSelect.addEventListener('change', updateRenderButtonState);
             // Fetch workflow options
             fetch('/api/workflows')
                 .then(res => {
                     if (!res.ok) throw new Error(`HTTP error ${res.status}`);
                     return res.json();
                 })
                 .then(data => {
                     const errorDiv = document.getElementById('workflow-error');
                     if (errorDiv) errorDiv.textContent = ''; // Clear previous errors
                     if (data.workflows) {
                         workflowSelect.innerHTML = '<option value="">--请选择--</option>';
                         data.workflows.forEach(wfPath => {
                             const option = document.createElement('option');
                             option.value = wfPath; // Value is the relative path
                             // Display a cleaner name (e.g., subdir/name)
                             option.textContent = wfPath.replace('.json', '').replace(/\\/g, '/');
                             workflowSelect.appendChild(option);
                         });
                     } else if (data.error) {
                         if (errorDiv) errorDiv.textContent = `加载工作流失败: ${data.error}`;
                         console.error("Workflow load error:", data.error);
                     }
                 })
                 .catch(err => {
                     const errorDiv = document.getElementById('workflow-error');
                     if (errorDiv) errorDiv.textContent = `加载工作流出错: ${err.message}`;
                     console.error("Workflow fetch error:", err);
                 })
                 .finally(() => {
                     updateRenderButtonState(); // Update button state after fetch attempt
                 });
        } else { console.error("Workflow select not found"); }

        // --- Input Setup (Previews and Live Value Display) ---
        function setupPreview(inputId, previewId) {
            const input = document.getElementById(inputId);
            const preview = document.getElementById(previewId);
            if (input && preview) {
                input.addEventListener('change', async (event) => {
                    const file = event.target.files[0];
                    const uploadBox = input.closest('.upload-box');
                    if (uploadBox) uploadBox.classList.remove('success', 'error'); // Reset visual state

                    if (file && file.type.startsWith('image/')) {
                        try {
                            preview.src = await readFileAsBase64(file);
                            preview.style.display = 'block';
                             if (uploadBox) uploadBox.classList.add('success'); // Mark as visually successful selection
                        } catch (e) {
                            preview.src = '#';
                            preview.style.display = 'none';
                             if (uploadBox) uploadBox.classList.add('error');
                            updateFooter("无法预览图像", 'error');
                        }
                    } else {
                        preview.src = '#';
                        preview.style.display = 'none';
                        if (file) { // If a file was selected but wasn't an image
                             if (uploadBox) uploadBox.classList.add('error');
                             updateFooter("请选择图像文件", 'error');
                        }
                    }
                });
            }
        }
        setupPreview('lineart-upload', 'lineart-preview');
        setupPreview('reference-upload', 'reference-preview');

        function setupSliderDisplay(sliderId, displayId, decimalPlaces = 0) {
            const slider = document.getElementById(sliderId);
            const display = document.getElementById(displayId);
            if (slider && display) {
                const updateDisplay = () => {
                    display.textContent = parseFloat(slider.value).toFixed(decimalPlaces);
                };
                slider.addEventListener('input', updateDisplay);
                updateDisplay(); // Set initial value
            }
        }
        setupSliderDisplay('control-strength', 'control-strength-value', 2); // 2 decimal places
        setupSliderDisplay('card-count', 'card-count-value', 0); // 0 decimal places


        // --- Render Button Click Listener ---
        if (renderBtn && workflowSelect) {
            renderBtn.addEventListener('click', async () => {
                if (renderBtn.disabled || isRendering) return; // Extra check

                const selectedWorkflowKey = workflowSelect.value;
                if (!selectedWorkflowKey) { updateFooter("请先选择工作流。", 'error'); return; }
                if (!mainSocket || !mainSocket.connected) { updateFooter("未连接到服务器。", 'error'); return; }

                isRendering = true; // Set rendering flag
                renderBtn.disabled = true;
                renderBtn.textContent = '渲染中...';
                updateFooter('开始渲染...', 'busy');
                updateStatusIndicator('开始渲染', 'busy');
                 const wfErrorDiv = document.getElementById('workflow-error');
                 if(wfErrorDiv) wfErrorDiv.textContent = ''; // Clear errors
                 if (outputPlaceholder) { outputPlaceholder.textContent = '正在初始化...'; outputPlaceholder.style.display = 'flex'; }
                 if (resultWrapper) resultWrapper.style.display = 'none';


                // --- Trigger prompt via Flask backend ---
                const payload = {
                    clientId: clientId, // Send our client ID
                    workflow_key: selectedWorkflowKey
                };
                console.log('-> Sending trigger request to backend:', payload);

                try {
                    const response = await fetch(`${APP_API_BASE}/api/trigger_prompt`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();

                    if (!response.ok || !result.success) {
                        throw new Error(result.message || `HTTP error ${response.status}`);
                    }

                    console.log('<- Backend Trigger Request Success:', result);
                    currentBackendPromptId = result.prompt_id; // Store the prompt ID we are tracking
                    updateFooter('任务已提交，等待 ComfyUI...', 'progress');
                    // Now wait for WebSocket messages (status, data requests, results)
                    // 现在等待 WebSocket 消息（状态、数据请求、结果）

                } catch (error) {
                    console.error('Error triggering prompt:', error);
                    updateFooter(`触发失败: ${error.message}`, 'error');
                    updateStatusIndicator('触发失败', 'error');
                    isRendering = false; // Reset flag on error
                    renderBtn.disabled = false; // Re-enable button
                    renderBtn.textContent = '渲染 (Render)';
                    if (outputPlaceholder) outputPlaceholder.textContent = `触发失败`;
                }
            });
        } else {
             console.error("Initialization Error: Cannot find render button or workflow select.");
        }

        // --- Other Button Listeners (Placeholders) ---
        if(saveBtn) saveBtn.addEventListener('click', () => { console.log('Save clicked'); updateFooter("保存功能未实现", 'idle'); });
        if(saveLargeBtn) saveLargeBtn.addEventListener('click', () => { console.log('Save Large clicked'); updateFooter("放大并保存功能未实现", 'idle'); });
        if (editToolbarElement) { editToolbarElement.querySelectorAll('.edit-icon').forEach((icon, index) => { icon.addEventListener('click', () => { console.log(`Edit Icon ${index + 1} clicked`); updateFooter(`编辑工具 ${index+1} 未实现`, 'idle'); }); }); }

        // --- Initialize WebSocket Connection ---
        connectWebSocket();
        updateRenderButtonState(); // Initial button state check

    });

    </script>

</body>
</html>